@model IEnumerable<StackFlow.ViewModels.UserReportViewModel>
@using System.Security.Claims

@{
    ViewData["Title"] = "User Reports";
}

<div class="card shadow-lg border-0 rounded-4 p-4 mt-4 mb-4">
    <h2 class="card-title text-center mb-4 fw-bold text-info display-6">
        <i class="bi bi-people-fill me-2"></i> User Reports
    </h2>
    <hr class="mb-4" />

    @if (!Model.Any())
    {
        <div class="alert alert-info text-center bg-transparent border-0" role="alert">
            <i class="bi bi-info-circle me-2"></i>No users found in the system.
        </div>
    }
    else
    {
        <div class="table-responsive">
            <table class="table table-hover table-striped align-middle rounded-3 overflow-hidden">
                <thead class="table-light">
                    <tr>
                        <th scope="col">Username</th>
                        <th scope="col">Email</th>
                        <th scope="col" class="text-center">Total Assigned Tickets</th> @* Text changed from Total Assigned Tasks *@
                        <th scope="col" class="text-center">To Do</th>
                        <th scope="col" class="text-center">In Progress</th>
                        <th scope="col" class="text-center">In Review</th>
                        <th scope="col" class="text-center">Done</th>
                        <th scope="col">Role</th>
                        <th scope="col" class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var report in Model)
                    {
                        <tr>
                            <td>
                                <strong>@report.User.Username</strong><br />
                                <small class="text-muted">Member since: @report.User.CreatedAt.ToShortDateString()</small>
                            </td>
                            <td>@report.User.Email</td>
                            <td class="text-center"><span class="badge bg-dark rounded-pill px-3 py-2">@report.TotalTicketsAssigned</span></td> @* Property changed from TotalTasksAssigned to TotalTicketsAssigned *@
                            <td class="text-center"><span class="badge bg-info rounded-pill px-3 py-2">@report.ToDoTicketsAssigned</span></td> @* Property changed from ToDoTasksAssigned to ToDoTicketsAssigned *@
                            <td class="text-center"><span class="badge bg-warning text-dark rounded-pill px-3 py-2">@report.InProgressTicketsAssigned</span></td> @* Property changed from InProgressTasksAssigned to InProgressTicketsAssigned *@
                            <td class="text-center"><span class="badge bg-purple rounded-pill px-3 py-2">@report.InReviewTicketsAssigned</span></td> @* Property changed from InReviewTasksAssigned to InReviewTicketsAssigned *@
                            <td class="text-center"><span class="badge bg-success rounded-pill px-3 py-2">@report.CompletedTicketsAssigned</span></td> @* Property changed from CompletedTasksAssigned to CompletedTicketsAssigned *@
                            <td>
                                @* Role dropdown only for Admins, and not for the current user * *@
                                @if (User.IsInRole("Admin") && report.User.Id != int.Parse(User.FindFirstValue(ClaimTypes.NameIdentifier)))
                                {
                                    <form asp-action="UpdateUserRole" method="post" class="d-inline-flex align-items-center" onchange="this.submit()">
                                        <input type="hidden" name="userId" value="@report.User.Id" />
                                        <select name="newRoleId" class="form-select form-select-sm rounded-pill me-2">
                                            @foreach (var role in ViewBag.Roles as SelectList)
                                            {
                                                <option value="@role.Value" selected="@(role.Value == report.User.RoleId.ToString())">@role.Text</option>
                                            }
                                        </select>
                                    </form>
                                }
                                else
                                {
                                    <span class="badge bg-secondary rounded-pill px-3 py-2">@report.User.Role?.Title</span>
                                }
                            </td>
                            <td class="text-center text-nowrap">
                                <button type="button" class="btn btn-outline-info btn-sm rounded-pill animate-btn me-2"
                                        data-bs-toggle="modal" data-bs-target="#userTicketsModal_@report.User.Id">
                                    @* ID changed from userTasksModal_ to userTicketsModal_ *@
                                    <i class="bi bi-list-task"></i> View Tickets @* Text changed from View Tasks *@
                                </button>
                                @* Delete User button - only for Admins, and not for the current user *@
                                @if (User.IsInRole("Admin") && report.User.Id != int.Parse(User.FindFirstValue(ClaimTypes.NameIdentifier)))
                                {
                                    <button type="button" class="btn btn-outline-danger btn-sm rounded-pill animate-btn"
                                            data-bs-toggle="modal" data-bs-target="#deleteUserModal_@report.User.Id">
                                        <i class="bi bi-trash"></i> Delete User
                                    </button>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <!-- Modals for viewing assigned tickets for each user -->
        @foreach (var report in Model)
        {
            <div class="modal fade" id="userTicketsModal_@report.User.Id" tabindex="-1" aria-labelledby="userTicketsModalLabel_@report.User.Id" aria-hidden="true">
                @* IDs changed from userTasksModal_ to userTicketsModal_ *@
                <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
                    <div class="modal-content rounded-4">
                        <div class="modal-header bg-info text-white rounded-top-4">
                            <h5 class="modal-title" id="userTicketsModalLabel_@report.User.Id">
                                @* ID changed from userTasksModalLabel_ to userTicketsModalLabel_ *@
                                Tickets Assigned to @report.User.Username @* Text changed from Tasks Assigned to *@
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            @if (!report.AssignedTickets.Any()) @* Property changed from AssignedTasks to AssignedTickets *@
                            {
                                <div class="alert alert-light text-center bg-transparent border-0" role="alert">No tickets assigned to this user.</div> @* Text changed to tickets *@
                            }
                            else
                            {
                                <ul class="list-group list-group-flush">
                                    @foreach (var ticket in report.AssignedTickets.OrderBy(t => t.DueDate)) @* Property changed from AssignedTasks to AssignedTickets, TaskDueDate to DueDate *@
                                    {
                                        <li class="list-group-item d-flex justify-content-between align-items-center border-0 rounded-3 mb-2 shadow-sm">
                                            <div>
                                                <h6 class="mb-1 text-primary">@ticket.Title</h6> @* Property changed from TaskTitle to Title *@
                                                <small class="text-muted">
                                                    Status: <span class="badge
                                                                                @(ticket.Status == "To Do" ? "bg-info" : @* Property changed from TaskStatus to Status *@
                                                                                                                                    ticket.Status == "In Progress" ? "bg-warning text-dark" : @* Property changed from TaskStatus to Status *@
                                                                                                                                    ticket.Status == "In Review" ? "bg-purple" : @* Property changed from TaskStatus to Status *@
                                                                                                                                    "bg-success") rounded-pill">@ticket.Status</span> | @* Property changed from TaskStatus to Status *@
                                                                                                                                   Priority: <span class="badge
                                                                                  @(ticket.Priority == "High" ? "bg-danger" : @* Property changed from TaskPriority to Priority *@
                                                                                                                                        ticket.Priority == "Medium" ? "bg-secondary" : "bg-primary") rounded-pill">@ticket.Priority</span> | @* Property changed from TaskPriority to Priority *@
                                    Due: @ticket.DueDate?.ToShortDateString() @* Property changed from TaskDueDate to DueDate *@
                                </small>
                            </div>
                            <a asp-action="TicketDetails" asp-route-id="@ticket.Id" class="btn btn-outline-secondary btn-sm rounded-pill animate-btn">
                                @* Action changed from TaskDetails to TicketDetails *@
                                View <i class="bi bi-arrow-right"></i>
                            </a>
                        </li>
                                                }
                                </ul>
                            }
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary rounded-pill animate-btn" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>

            @* Delete User Confirmation Modal - Only for Admin *@
            @if (User.IsInRole("Admin") && report.User.Id != int.Parse(User.FindFirstValue(ClaimTypes.NameIdentifier)))
            {
                <div class="modal fade" id="deleteUserModal_@report.User.Id" tabindex="-1" aria-labelledby="deleteUserModalLabel_@report.User.Id" aria-hidden="true">
                    <div class="modal-dialog modal-sm modal-dialog-centered">
                        <div class="modal-content rounded-4">
                            <div class="modal-header bg-danger text-white rounded-top-4">
                                <h5 class="modal-title" id="deleteUserModalLabel_@report.User.Id">Confirm Deletion</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body text-center">
                                <p>Are you sure you want to delete user <strong>@report.User.Username</strong>?</p>
                                <p class="text-danger"><small>All their tickets will be reassigned to you.</small></p> @* Text changed to tickets *@
                            </div>
                            <div class="modal-footer justify-content-center">
                                <button type="button" class="btn btn-secondary rounded-pill animate-btn" data-bs-dismiss="modal">Cancel</button>
                                <form asp-action="DeleteUser" method="post" class="d-inline">
                                    <input type="hidden" name="id" value="@report.User.Id" />
                                    <button type="submit" class="btn btn-danger rounded-pill animate-btn">
                                        Delete
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            }
        }
    }

    <div class="mt-4 text-center">
        <a asp-action="Index" class="btn btn-outline-secondary btn-lg rounded-pill animate-btn">
            <i class="bi bi-arrow-left-circle me-2"></i> Back to Dashboard
        </a>
    </div>
</div>

@section Scripts {
    <!-- Any user reports specific JavaScript can go here -->
}

@section Styles {
    <link rel="stylesheet" href="~/css/_UserReports.css" />
    <style>
        /* Specific theme-dependent colors if needed (for bg-purple in modals/badges) */
        [data-bs-theme="light"] {
            --bs-purple: #6f42c1;
        }

        [data-bs-theme="dark"] {
            --bs-purple: #bb86fc;
        }

        .bg-purple {
            background-color: var(--bs-purple) !important;
            color: #fff !important;
        }
    </style>
}
